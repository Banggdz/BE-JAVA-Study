ğŸ§© NHÃ“M: Authentication with Spring Security

Má»¥c tiÃªu: XÃ¡c thá»±c (authentication) ngÆ°á»i dÃ¹ng â€” kiá»ƒm tra danh tÃ­nh, Ä‘áº£m báº£o â€œbáº¡n lÃ  aiâ€.

1ï¸âƒ£ Spring Security Form Login
ğŸ”¹ Má»¥c Ä‘Ã­ch

Cáº¥u hÃ¬nh Ä‘Äƒng nháº­p báº±ng form HTML (username/password) â€” cÃ¡ch truyá»n thá»‘ng nháº¥t trong á»©ng dá»¥ng web.

ğŸ”¹ CÃ¡ch hoáº¡t Ä‘á»™ng

Spring Security tá»± Ä‘á»™ng cung cáº¥p má»™t form login máº·c Ä‘á»‹nh táº¡i /login.

Khi ngÆ°á»i dÃ¹ng gá»­i form, request Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n UsernamePasswordAuthenticationFilter.

Filter nÃ y:

Láº¥y username + password tá»« form.

Gá»­i Ä‘áº¿n AuthenticationManager Ä‘á»ƒ xÃ¡c thá»±c.

Náº¿u thÃ nh cÃ´ng â†’ lÆ°u thÃ´ng tin Authentication vÃ o SecurityContextHolder.

Náº¿u tháº¥t báº¡i â†’ chuyá»ƒn hÆ°á»›ng vá» /login?error.

ğŸ”¹ Code cáº¥u hÃ¬nh
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests()
                .requestMatchers("/home", "/register").permitAll()
                .anyRequest().authenticated()
            .and()
            .formLogin()
                .loginPage("/login") // tÃ¹y chá»‰nh trang login
                .defaultSuccessUrl("/dashboard", true)
                .failureUrl("/login?error=true")
            .and()
            .logout()
                .logoutSuccessUrl("/login?logout=true");
        return http.build();
    }
}

ğŸ”¹ Lá»—i thÆ°á»ng gáº·p

KhÃ´ng táº¡o controller hoáº·c view cho /login â†’ lá»—i 404.

KhÃ´ng táº¯t CSRF trong khi test báº±ng Postman â†’ login tháº¥t báº¡i.

QuÃªn @EnableWebSecurity â†’ cáº¥u hÃ¬nh khÃ´ng kÃ­ch hoáº¡t.

2ï¸âƒ£ Basic Authentication
ğŸ”¹ Má»¥c Ä‘Ã­ch

DÃ¹ng header HTTP Basic Auth (Authorization: Basic base64(username:password)) cho API.

ğŸ”¹ CÆ¡ cháº¿

KhÃ´ng cÃ³ form HTML.

Spring Security sáº½ kiá»ƒm tra header Authorization.

Náº¿u há»£p lá»‡ â†’ táº¡o Authentication object â†’ lÆ°u vÃ o SecurityContext.

ğŸ”¹ Code cáº¥u hÃ¬nh
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .csrf().disable()
        .authorizeHttpRequests()
            .anyRequest().authenticated()
        .and()
        .httpBasic(); // báº­t Basic Auth
    return http.build();
}

ğŸ”¹ Æ¯u / NhÆ°á»£c Ä‘iá»ƒm
Æ¯u Ä‘iá»ƒm	NhÆ°á»£c Ä‘iá»ƒm
ÄÆ¡n giáº£n, phÃ¹ há»£p API ná»™i bá»™	Gá»­i máº­t kháº©u má»—i request
Dá»… test báº±ng Postman	KhÃ´ng nÃªn dÃ¹ng náº¿u khÃ´ng cÃ³ HTTPS
3ï¸âƒ£ Custom AuthenticationProvider
ğŸ”¹ Má»¥c Ä‘Ã­ch

Tá»± Ä‘á»‹nh nghÄ©a cÃ¡ch xÃ¡c thá»±c riÃªng thay vÃ¬ dÃ¹ng máº·c Ä‘á»‹nh cá»§a Spring.

ğŸ”¹ CÆ¡ cháº¿

Báº¡n táº¡o class implement AuthenticationProvider.

Trong authenticate(), kiá»ƒm tra user/password (VD: DB, LDAP, APIâ€¦).

Náº¿u há»£p lá»‡ â†’ tráº£ vá» UsernamePasswordAuthenticationToken.

ğŸ”¹ Code vÃ­ dá»¥
@Component
public class CustomAuthProvider implements AuthenticationProvider {
    @Override
    public Authentication authenticate(Authentication auth) throws AuthenticationException {
        String username = auth.getName();
        String password = auth.getCredentials().toString();

        if ("admin".equals(username) && "123".equals(password)) {
            return new UsernamePasswordAuthenticationToken(username, password, List.of());
        }
        throw new BadCredentialsException("Sai thÃ´ng tin Ä‘Äƒng nháº­p!");
    }

    @Override
    public boolean supports(Class<?> auth) {
        return auth.equals(UsernamePasswordAuthenticationToken.class);
    }
}

ğŸ”¹ ÄÄƒng kÃ½ vÃ o SecurityConfig
@Autowired
private CustomAuthProvider authProvider;

@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    return http.authenticationProvider(authProvider)
               .formLogin().and()
               .build();
}

4ï¸âƒ£ Manually Authenticate User
ğŸ”¹ Má»¥c Ä‘Ã­ch

XÃ¡c thá»±c thá»§ cÃ´ng trong code (vÃ­ dá»¥ sau khi ngÆ°á»i dÃ¹ng Ä‘Äƒng kÃ½ hoáº·c dÃ¹ng token riÃªng).

ğŸ”¹ CÃ¡ch lÃ m

DÃ¹ng AuthenticationManager Ä‘á»ƒ xÃ¡c thá»±c má»™t UsernamePasswordAuthenticationToken thá»§ cÃ´ng.

ğŸ”¹ Code vÃ­ dá»¥
@Autowired
private AuthenticationManager authManager;

@PostMapping("/manual-login")
public String manualLogin(@RequestParam String username, @RequestParam String password) {
    Authentication auth = new UsernamePasswordAuthenticationToken(username, password);
    Authentication result = authManager.authenticate(auth);
    SecurityContextHolder.getContext().setAuthentication(result);
    return "Login thÃ nh cÃ´ng!";
}

5ï¸âƒ£ Custom AuthenticationFailureHandler
ğŸ”¹ Má»¥c Ä‘Ã­ch

TÃ¹y chá»‰nh hÃ nh vi khi Ä‘Äƒng nháº­p tháº¥t báº¡i (vÃ­ dá»¥: ghi log, giá»›i háº¡n láº§n sai).

ğŸ”¹ Code vÃ­ dá»¥
@Component
public class CustomFailureHandler implements AuthenticationFailureHandler {
    @Override
    public void onAuthenticationFailure(HttpServletRequest req, HttpServletResponse res,
                                        AuthenticationException ex) throws IOException {
        res.sendRedirect("/login?error=" + ex.getMessage());
    }
}

ğŸ”¹ ÄÄƒng kÃ½
.formLogin()
    .failureHandler(customFailureHandler)

6ï¸âƒ£ Login Page with React
ğŸ”¹ Má»¥c Ä‘Ã­ch

TÃ­ch há»£p Spring Security backend vá»›i frontend (React, Angular).

ğŸ”¹ CÃ¡ch lÃ m

Frontend gá»­i POST /login vá»›i JSON {username, password}.

Backend xá»­ lÃ½ xÃ¡c thá»±c, tráº£ vá» JWT hoáº·c session cookie.

DÃ¹ng cors() vÃ  csrf().disable() khi test API.

ğŸ”¹ VÃ­ dá»¥ rÃºt gá»n
http
  .csrf().disable()
  .cors()
  .and()
  .authorizeHttpRequests()
    .anyRequest().authenticated()
  .and()
  .formLogin()
    .loginProcessingUrl("/api/login")
    .successHandler((req, res, auth) -> res.setStatus(200))
    .failureHandler((req, res, ex) -> res.setStatus(401));

7ï¸âƒ£ Upgrading WebSecurityConfigurerAdapter (Deprecated)
ğŸ”¹ Bá»‘i cáº£nh

Spring Security 5.7 bá» WebSecurityConfigurerAdapter, thay báº±ng SecurityFilterChain (functional config).

ğŸ”¹ Code má»›i
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests()
            .anyRequest().authenticated()
            .and()
            .formLogin();
        return http.build();
    }
}

8ï¸âƒ£ Securing API With API Key and Secret
ğŸ”¹ Má»¥c Ä‘Ã­ch

DÃ¹ng API Key thay vÃ¬ username/password (thÆ°á»ng dÃ¹ng cho há»‡ thá»‘ng backend hoáº·c microservices).

ğŸ”¹ CÃ¡ch lÃ m

ThÃªm header X-API-KEY vÃ o request.

Viáº¿t custom filter kiá»ƒm tra key.

ğŸ”¹ VÃ­ dá»¥ filter
@Component
public class ApiKeyFilter extends OncePerRequestFilter {
    @Override
    protected void doFilterInternal(HttpServletRequest req, HttpServletResponse res, FilterChain chain)
            throws IOException, ServletException {
        String apiKey = req.getHeader("X-API-KEY");
        if (!"my-secret-key".equals(apiKey)) {
            res.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            return;
        }
        chain.doFilter(req, res);
    }
}

ğŸ”¹ ThÃªm vÃ o chain
http.addFilterBefore(apiKeyFilter, UsernamePasswordAuthenticationFilter.class);

9ï¸âƒ£ Securing with SSL Bundles
ğŸ”¹ Má»¥c Ä‘Ã­ch

Cáº¥u hÃ¬nh SSL cho Spring Boot (HTTPS).

ğŸ”¹ application.yml
server:
  ssl:
    bundle: mybundle
spring:
  ssl:
    bundle:
      pem:
        mybundle:
          keystore:
            certificate: classpath:cert.pem
            private-key: classpath:key.pem


â†’ GiÃºp mÃ£ hÃ³a dá»¯ liá»‡u Ä‘Äƒng nháº­p khi dÃ¹ng Basic/Form Auth.

ğŸ”Ÿ Two Factor Authentication (2FA)
ğŸ”¹ Má»¥c Ä‘Ã­ch

Bá»• sung lá»›p xÃ¡c thá»±c thá»© hai (vÃ­ dá»¥ OTP, email code, Google Authenticator).

ğŸ”¹ CÃ¡ch lÃ m

Sau khi login thÃ nh cÃ´ng â†’ gá»­i mÃ£ OTP tá»›i user.

Chuyá»ƒn hÆ°á»›ng sang /verify-otp.

Khi ngÆ°á»i dÃ¹ng nháº­p Ä‘Ãºng OTP â†’ hoÃ n táº¥t xÃ¡c thá»±c.

ğŸ”¹ Ã tÆ°á»Ÿng chÃ­nh:

Login â†’ táº¡o PartialAuthentication.

Sau khi OTP há»£p lá»‡ â†’ nÃ¢ng cáº¥p lÃªn FullAuthentication.

11ï¸âƒ£ Authenticating Users with AzureAD
ğŸ”¹ Má»¥c Ä‘Ã­ch

TÃ­ch há»£p Spring Boot vá»›i Microsoft Azure Active Directory (SSO).

ğŸ”¹ Cáº¥u hÃ¬nh Maven
<dependency>
  <groupId>com.azure.spring</groupId>
  <artifactId>azure-spring-boot-starter-active-directory</artifactId>
</dependency>

ğŸ”¹ application.yml
azure:
  activedirectory:
    tenant-id: <tenant-id>
    client-id: <client-id>
    client-secret: <secret>

ğŸ”¹ Cáº¥u hÃ¬nh
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
            .oauth2Login();
        return http.build();
    }
}
