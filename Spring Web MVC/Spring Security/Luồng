Luá»“ng: https://viblo.asia/p/van-de-bao-mat-api-bang-spring-security-jvElao66Kkw
https://viblo.asia/p/lam-sao-bao-mat-ung-dung-spring-voi-spring-security-va-jwt-yZjJYKXbVOE
https://viblo.asia/p/huong-dan-spring-security-co-ban-de-hieu-OeVKBdedlkW
jwt: https://viblo.asia/p/huong-dan-spring-security-jwt-json-web-token-hibernate-oOVlYGmoK8W

ğŸ” Ã tÆ°á»Ÿng: CÃ¡ch Spring Security biáº¿t ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p hay chÆ°a

Khi báº¡n Ä‘Äƒng nháº­p qua form (vÃ­ dá»¥ /login):
1ï¸âƒ£ Spring Security kiá»ƒm tra thÃ´ng tin ngÆ°á»i dÃ¹ng (qua UserDetailsService, DB, v.v.)
2ï¸âƒ£ Náº¿u há»£p lá»‡ â†’ nÃ³ ghi láº¡i ngÆ°á»i dÃ¹ng Ä‘ang Ä‘Äƒng nháº­p vÃ o má»™t vÃ¹ng Ä‘áº·c biá»‡t:
ğŸ‘‰ SecurityContextHolder (chá»©a Ä‘á»‘i tÆ°á»£ng Authentication)
3ï¸âƒ£ Authentication nÃ y lÆ°u thÃ´ng tin nhÆ°:

principal: ngÆ°á»i dÃ¹ng hiá»‡n táº¡i (username, vai trÃ², v.v.)
authorities: danh sÃ¡ch quyá»n
authenticated: cá» true/false (Ä‘Ã£ Ä‘Äƒng nháº­p chÆ°a)

Sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng, má»i request gá»­i lÃªn (dÃ¹ lÃ  trang khÃ¡c) Spring Security sáº½ tá»± gáº¯n láº¡i thÃ´ng tin user tá»« session â€” báº¡n khÃ´ng cáº§n lÃ m thá»§ cÃ´ng:
SecurityContext
 â””â”€â”€ Authentication
      â”œâ”€â”€ principal
      â”œâ”€â”€ authorities
      â””â”€â”€ authenticated = true


Authentication = thÃ´ng tin xÃ¡c thá»±c hiá»‡n táº¡i
principal = thÃ´ng tin ngÆ°á»i dÃ¹ng

1ï¸âƒ£ principal cÃ³ thá»ƒ lÃ  nhá»¯ng kiá»ƒu gÃ¬?
TrÆ°á»ng há»£p 1: ChÆ°a Ä‘Äƒng nháº­p
principal = "anonymousUser"

TrÆ°á»ng há»£p 2: DÃ¹ng Spring Security máº·c Ä‘á»‹nh
principal instanceof org.springframework.security.core.userdetails.User

VÃ­ dá»¥:
User(username=user, password=[PROTECTED], authorities=[ROLE_USER])

TrÆ°á»ng há»£p 3: DÃ¹ng UserEntity + CustomUserDetails (phá»• biáº¿n nháº¥t)
principal instanceof CustomUserDetails

public class CustomUserDetails implements UserDetails {
    private UserEntity user;
}

â¡ï¸ principal chÃ­nh lÃ  CustomUserDetails

2ï¸âƒ£ Láº¥y principal báº±ng cÃ¡ch nÃ o?
CÃ¡ch 1: Tá»« SecurityContext
Authentication auth =
    SecurityContextHolder.getContext().getAuthentication();

Object principal = auth.getPrincipal();

CÃ¡ch 2: Ã‰p kiá»ƒu (thÆ°á»ng dÃ¹ng)
CustomUserDetails user =
    (CustomUserDetails) auth.getPrincipal();

CÃ¡ch 3: CÃ¡ch chuáº©n nháº¥t (Controller)
@GetMapping("/profile")
public String profile(@AuthenticationPrincipal CustomUserDetails user) {
    System.out.println(user.getUsername());
    return "profile";
}
3ï¸âƒ£ UserDetailsService vÃ  UserDetails
1. PhÃ¢n biá»‡t 2 khÃ¡i niá»‡m trong 1 cÃ¢u

UserDetailsService = nÆ¡i Láº¤Y user
UserDetails = thÃ´ng tin user ÄÃƒ Láº¤Y ra

2. UserDetailsService (dÃ¹ng khi chÆ°a ÄÄ‚NG NHáº¬P)

UserDetailsService lÃ  SERVICE mÃ  Spring gá»i Ä‘á»ƒ tÃ¬m user khi Ä‘Äƒng nháº­p
Cáº¥u hÃ¬nh Security
Láº¥y user tá»« DB
Viáº¿t logic Ä‘Äƒng nháº­p

public interface UserDetailsService {
    UserDetails loadUserByUsername(String username);
}

@Service
public class CustomUserDetailsService
        implements UserDetailsService {
    @Override
    public UserDetails loadUserByUsername(String username) {
    
        UserEntity user = userRepository.findByUserName(username)
            .orElseThrow(() ->
                new UsernameNotFoundException("User not found")
            );
    
        return new CustomUserDetails(user);
    }
}
ğŸ”¹ loadUserByUsername(String username)
ÄÆ°á»£c Spring Security tá»± Ä‘á»™ng gá»i khi Ä‘Äƒng nháº­p

Nhiá»‡m vá»¥:

TÃ¬m user theo username
Tráº£ vá» UserDetails
Náº¿u khÃ´ng cÃ³ user â†’ throw exception

ğŸ“Œ NÃ³ chá»‰ tá»“n táº¡i lÃºc Ä‘Äƒng nháº­p
ğŸ“Œ NÃ³ khÃ´ng Ä‘Æ°á»£c lÆ°u trong session

ğŸ‘‰ Vai trÃ²: Ä‘i DB / API Ä‘á»ƒ tÃ¬m user

3. UserDetails lÃ  gÃ¬? (dÃ¹ng sau khi ÄÄ‚NG NHáº¬P)

UserDetails lÃ  object chá»©a thÃ´ng tin user mÃ  Spring Security sá»­ dá»¥ng
Láº¥y user Ä‘Ã£ Ä‘Äƒng nháº­p
PhÃ¢n quyá»n
Láº¥y thÃ´ng tin user hiá»‡n táº¡i

@AuthenticationPrincipal CustomUserDetails userDetails

public interface UserDetails {
    String getUsername();
    String getPassword();
    Collection<? extends GrantedAuthority> getAuthorities();
}

ğŸ“Œ NÃ³ Ä‘Æ°á»£c lÆ°u trong session
ğŸ“Œ NÃ³ chÃ­nh lÃ  principal

4. VÃ­ dá»¥ Ä‘á»i thá»±c (ráº¥t dá»… nhá»›)
VÃ­ dá»¥: Ä‘i mua hÃ ng
Thá»±c táº¿	Spring Security
NhÃ¢n viÃªn há»i CMND	Spring gá»i UserDetailsService
Báº¡n Ä‘Æ°a CMND	UserDetailsService tráº£ UserDetails
NhÃ¢n viÃªn giá»¯ thÃ´ng tin	Spring lÆ°u UserDetails
Báº¡n Ä‘i Ä‘Ã¢u cÅ©ng Ä‘Æ°á»£c nháº­n diá»‡n	principal

5. Luá»“ng chuáº©n (quan trá»ng)
FORM LOGIN
   |
   v
UserDetailsService.loadUserByUsername()
   |
   v
UserDetails (CustomUserDetails)
   |
   v
Authentication.principal
   |
   v
SecurityContext (SESSION)


